CREATE TABLE STATS(
                      STAT_ID INT(11) AUTO_INCREMENT,
                      STAT_DATE DATETIME NOT NULL,
                      STAT VARCHAR(20) NOT NULL,
                      VALUE INT(11) NOT NULL,
                      PRIMARY KEY (STAT_ID)
);


CREATE VIEW BESTSELLERS_COUNT AS
SELECT COUNT(*) AS NO_BESTSELLERS
FROM BOOKS
WHERE BESTSELLER=1;

DROP EVENT IF EXISTS COUNT_BESTSELLERS;

DELIMITER $$

CREATE EVENT COUNT_BESTSELLERS
    ON SCHEDULE
        EVERY 1 MINUTE
    DO BEGIN
    DECLARE num INT;
    CALL UpdateBestSellers();
    SET @date = CURTIME();
     SET num = (SELECT NO_BESTSELLERS FROM BESTSELLERS_COUNT);
    INSERT INTO STATS(STAT_DATE, STAT, VALUE)
        VALUE (@date, "BESTSELLERS", num);
    COMMIT;
  DELETE FROM STATS where STAT_DATE = @date;
    COMMIT;
END $$

DELIMITER ;

